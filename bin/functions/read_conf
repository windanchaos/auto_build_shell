#!/bin/bash
##############################################################################
###    配置文件语法检查
###    传入参数 文件名  
###    返回值   0,合法;其他值非法或出错  
##############################################################################
function check_syntax(){  
    if [ ! -f $1 ];then   
        return 1  
    fi  
  
    ret=$(awk -F= 'BEGIN{valid=1}  
    {  
        #已经找到非法行,则一直略过处理  
        if(valid == 0) next  
        #忽略空行     
        if(length($0) == 0) next  
        #消除所有的空格  
        gsub(" |\t","",$0)    
        #检测是否是注释行     
        head_char=substr($0,1,1)  
        if (head_char != "#"){  
            #不是字段=值 形式的检测是否是块名  
            if( NF == 1){  
                b=substr($0,1,1)  
                len=length($0)  
                e=substr($0,len,1)  
                if (b != "[" || e != "]"){  
                    valid=0  
                }  
            }else if( NF == 2){  
            #检测字段=值 的字段开头是否是[  
                b=substr($0,1,1)  
                if (b == "["){  
                    valid=0  
                }  
            }else{  
            #存在多个=号分割的都非法  
                valid=0  
            }     
        }  
    }  
    END{print valid}' $1)  
      
    if [ $ret -eq 1 ];then  
        return 0  
    else  
        return 2  
    fi  
}

##############################################################################
###    读取配置文件 [配置文件路径+名称] [节点名] [键值]
##############################################################################
function read_ini() {
    ini_file=$1;
    section=$2;
    key=$3
    # 读取配置文件，排除'#'开头的行，将结果作为awk的输入
    # 以'='做分隔符,找到节点下面的匹配key的行，按'='分割为$1 $2 $2即所需要的值，如果$2为逗号分开的数组 则转换为shell数组
    sed -e s/^#.*//g $ini_file | awk -F '=' '/^[^#]/{}/\['$section'\]/{a=1}a==1&&$1~/'$key'/{ for (i=1; i<= split($2,array,","); i++) print array[i]" "}'
    # awk -F '=' '/\['$section'\]/{a=1}a==1&&$1~/'$key'/{ print $2 }' $ini_file
}
